name: Upload test artifacts

description: |
  Upload various artifacts produced by our testing process.
  Attempts to upload to S3 first, and falls back to GitHub Actions artifacts if S3 upload fails.

inputs:
  use-gha:
    description: |
      Deprecated: This input is no longer used. The action now automatically
      attempts S3 upload first and falls back to GHA if S3 fails.
    required: false
  file-suffix:
    description: |
      Suffix to add to the filename of the artifacts. This should include the
      workflow job id, see [Job id in artifacts].
    required: true
  s3-bucket:
    description: S3 bucket to upload artifacts to
    required: false
    default: "gha-artifacts"

runs:
  using: composite
  steps:
    # Always set up uv and zip files first (needed for S3, reusable for GHA fallback)
    - name: Setup uv
      if: runner.os != 'Windows'
      uses: astral-sh/setup-uv@f0ec1fc3b38f5e7cd731bb6ce540c5af426746bb # v6.1.0
      with:
        python-version: 3.12

    - name: Zip artifacts for upload
      if: runner.os != 'Windows'
      shell: bash
      env:
        FILE_SUFFIX: ${{ inputs.file-suffix }}
      run: |
        set -euo pipefail
        rm -f test-jsons-*.zip test-reports-*.zip logs-*.zip debug-*.zip
        ZIP_CMD='
        import sys, zipfile, os
        from pathlib import Path
        d = Path(sys.argv[1])
        o = Path(sys.argv[2])
        p = sys.argv[3:]
        with zipfile.ZipFile(o, "w", zipfile.ZIP_DEFLATED) as z:
            for pat in p:
                for f in d.glob(pat):
                    if f.is_file():
                        z.write(f, os.path.relpath(f, d))
        '
        uv run --no-project python -c "$ZIP_CMD" \
          test/test-reports "test-jsons-${FILE_SUFFIX}.zip" '**/*.json'
        uv run --no-project python -c "$ZIP_CMD" \
          . "test-reports-${FILE_SUFFIX}.zip" 'test/test-reports/**/*.xml' 'test/test-reports/**/*.csv'
        uv run --no-project python -c "$ZIP_CMD" \
          . "logs-${FILE_SUFFIX}.zip" 'usage_log.txt' 'test/test-reports/**/*.log'
        if [ -d 'test/debug' ]; then
          uv run --no-project python -c "$ZIP_CMD" \
            test/debug "debug-${FILE_SUFFIX}.zip" '**/*'
        fi

    # Windows zip
    - name: Zip JSONs for upload
      if: runner.os == 'Windows'
      shell: powershell
      env:
        FILE_SUFFIX: ${{ inputs.file-suffix }}
      run: |
        # -ir => recursive include all files in pattern
        7z a "test-jsons-$Env:FILE_SUFFIX.zip" -ir'!test\test-reports\*.json'

    - name: Zip test reports for upload
      if: runner.os == 'Windows'
      shell: powershell
      env:
        FILE_SUFFIX: ${{ inputs.file-suffix }}
      run: |
        # -ir => recursive include all files in pattern
        7z a "test-reports-$Env:FILE_SUFFIX.zip" -ir'!test\test-reports\*.xml' -ir'!test\test-reports\*.csv'

    - name: Zip usage log for upload
      if: runner.os == 'Windows'
      continue-on-error: true
      shell: powershell
      env:
        FILE_SUFFIX: ${{ inputs.file-suffix }}
      run: |
        # -ir => recursive include all files in pattern
        7z a "logs-$Env:FILE_SUFFIX.zip" 'usage_log.txt' -ir'!test\test-reports\*.log'

    # ===========================================
    # S3 upload (primary path)
    # ===========================================
    - name: Store Test Downloaded JSONs on S3
      id: s3-upload-jsons
      uses: seemethere/upload-artifact-s3@v5
      continue-on-error: true
      with:
        s3-bucket: ${{ inputs.s3-bucket }}
        s3-prefix: |
          ${{ github.repository }}/${{ github.run_id }}/${{ github.run_attempt }}/artifact
        retention-days: 14
        if-no-files-found: warn
        path: test-jsons-*.zip

    - name: Store Test Reports on S3
      id: s3-upload-reports
      uses: seemethere/upload-artifact-s3@v5
      continue-on-error: true
      with:
        s3-bucket: ${{ inputs.s3-bucket }}
        s3-prefix: |
          ${{ github.repository }}/${{ github.run_id }}/${{ github.run_attempt }}/artifact
        retention-days: 14
        if-no-files-found: warn
        path: test-reports-*.zip

    - name: Store Usage Logs on S3
      id: s3-upload-logs
      uses: seemethere/upload-artifact-s3@v5
      continue-on-error: true
      with:
        s3-bucket: ${{ inputs.s3-bucket }}
        s3-prefix: |
          ${{ github.repository }}/${{ github.run_id }}/${{ github.run_attempt }}/artifact
        retention-days: 14
        if-no-files-found: ignore
        path: logs-*.zip

    - name: Store Debug Artifacts on S3
      id: s3-upload-debug
      uses: seemethere/upload-artifact-s3@v5
      continue-on-error: true
      with:
        s3-bucket: ${{ inputs.s3-bucket }}
        s3-prefix: |
          ${{ github.repository }}/${{ github.run_id }}/${{ github.run_attempt }}/artifact
        retention-days: 14
        if-no-files-found: ignore
        path: debug-*.zip

    # Check if S3 upload failed (test-reports is the critical one)
    - name: Check S3 upload status
      id: check-s3
      shell: bash
      run: |
        if [[ "${{ steps.s3-upload-reports.outcome }}" == "failure" ]]; then
          echo "S3 upload failed, will fallback to GHA"
          echo "s3-failed=true" >> "$GITHUB_OUTPUT"
        else
          echo "S3 upload succeeded"
          echo "s3-failed=false" >> "$GITHUB_OUTPUT"
        fi

    # ===========================================
    # GHA upload (fallback path if S3 failed)
    # ===========================================
    - name: Store Test Downloaded JSONs on Github (fallback)
      uses: actions/upload-artifact@v4
      if: steps.check-s3.outputs.s3-failed == 'true'
      continue-on-error: true
      with:
        # Add the run attempt, see [Artifact run attempt]
        name: test-jsons-runattempt${{ github.run_attempt }}-${{ inputs.file-suffix }}.zip
        retention-days: 14
        if-no-files-found: warn
        path: test/**/*.json

    - name: Store Test Reports on Github (fallback)
      uses: actions/upload-artifact@v4
      if: steps.check-s3.outputs.s3-failed == 'true'
      continue-on-error: true
      with:
        # Add the run attempt, see [Artifact run attempt]
        name: test-reports-runattempt${{ github.run_attempt }}-${{ inputs.file-suffix }}.zip
        retention-days: 14
        if-no-files-found: warn
        path: |
          test/**/*.xml
          test/**/*.csv

    - name: Store Usage Logs on Github (fallback)
      uses: actions/upload-artifact@v4
      if: steps.check-s3.outputs.s3-failed == 'true'
      continue-on-error: true
      with:
        # Add the run attempt, see [Artifact run attempt]
        name: logs-runattempt${{ github.run_attempt }}-${{ inputs.file-suffix }}.zip
        retention-days: 14
        if-no-files-found: ignore
        path: |
          usage_log.txt
          test/**/*.log
