name: Build Flash Attention 3 wheels

on:
  workflow_dispatch:
  # TODO: Remove this trigger before merging - only for testing from PR branch
  push:
    branches:
      - flash-attn3

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  get-label-type:
    if: github.repository_owner == 'pytorch'
    name: get-label-type
    uses: pytorch/pytorch/.github/workflows/_runner-determinator.yml@main
    with:
      triggering_actor: ${{ github.triggering_actor }}
      issue_owner: ${{ github.event.pull_request.user.login || github.event.issue.user.login }}
      curr_branch: ${{ github.head_ref || github.ref_name }}
      curr_ref_type: ${{ github.ref_type }}

  build-wheel:
    name: "Build FA3 ${{ matrix.cuda_version }} ${{ matrix.arch }}"
    needs: get-label-type
    runs-on: "${{ needs.get-label-type.outputs.label-type }}${{ matrix.runner }}"
    strategy:
      fail-fast: false
      matrix:
        include:
          - cuda_version: "12.6"
            arch: "x86_64"
            cuda_short: "126"
            torch_cuda_arch_list: "8.0;8.6;9.0"
            docker_image: "pytorch/manylinux2_28-builder:cuda12.6"
            runner: "linux.4xlarge"
          - cuda_version: "13.0"
            arch: "x86_64"
            cuda_short: "130"
            torch_cuda_arch_list: "8.0;8.6;9.0;10.0"
            docker_image: "pytorch/manylinux2_28-builder:cuda13.0"
            runner: "linux.4xlarge"
          - cuda_version: "12.6"
            arch: "aarch64"
            cuda_short: "126"
            torch_cuda_arch_list: "8.0;8.6;9.0"
            docker_image: "pytorch/manylinuxaarch64-builder:cuda12.6"
            runner: "linux.arm64.2xlarge"
          - cuda_version: "13.0"
            arch: "aarch64"
            cuda_short: "130"
            torch_cuda_arch_list: "8.0;8.6;9.0;10.0"
            docker_image: "pytorch/manylinuxaarch64-builder:cuda13.0"
            runner: "linux.arm64.2xlarge"
    timeout-minutes: 60
    env:
      DOCKER_IMAGE: ${{ matrix.docker_image }}
      CUDA_VERSION: ${{ matrix.cuda_version }}
      CUDA_SHORT: ${{ matrix.cuda_short }}
      TORCH_CUDA_ARCH_LIST: ${{ matrix.torch_cuda_arch_list }}
    steps:
      - name: Setup SSH (Click me for login details)
        uses: pytorch/test-infra/.github/actions/setup-ssh@main
        with:
          github-secret: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PyTorch
        uses: pytorch/pytorch/.github/actions/checkout-pytorch@main
        with:
          submodules: true

      - name: Setup Linux
        uses: ./.github/actions/setup-linux

      - name: Pull Docker image
        uses: pytorch/test-infra/.github/actions/pull-docker-image@main
        with:
          docker-image: ${{ env.DOCKER_IMAGE }}

      - name: Build Flash Attention 3 wheel
        run: |
          set -x
          mkdir -p "${RUNNER_TEMP}/artifacts/"
          container_name=$(docker run \
            --tty \
            --detach \
            -v "${GITHUB_WORKSPACE}:/pytorch" \
            -v "${RUNNER_TEMP}/artifacts:/artifacts" \
            -w /pytorch \
            "${DOCKER_IMAGE}"
          )

          docker exec -t "${container_name}" bash -c \
            "pip install torch --index-url https://download.pytorch.org/whl/cu${CUDA_SHORT}"

          docker exec -t \
            -e TORCH_CUDA_ARCH_LIST="${TORCH_CUDA_ARCH_LIST}" \
            -e FA_FINAL_PACKAGE_DIR="/artifacts" \
            -e WHEEL_PLAT="${{ matrix.arch }}" \
            -e PYTORCH_ROOT="/pytorch" \
            "${container_name}" bash -c \
            "bash /pytorch/.ci/flash-attention/build.sh"

          docker exec -t "${container_name}" chown -R 1000:1000 /artifacts

      - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: flash-attn-3-wheel-cu${{ matrix.cuda_short }}-${{ matrix.arch }}
          if-no-files-found: error
          path: ${{ runner.temp }}/artifacts/*.whl

      - name: Teardown Linux
        uses: pytorch/test-infra/.github/actions/teardown-linux@main
        if: always()
