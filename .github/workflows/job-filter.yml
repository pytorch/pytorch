name: job-filter

# Job Filter Rules (for trunk.yml, pull.yml)
# ==========================================
# 1. DEFAULT PATTERN - use job's display name (from `name:` field) with space padding:
#      if: ${{ needs.job-filter.outputs.jobs == '' || contains(needs.job-filter.outputs.jobs, ' DISPLAY-NAME ') }}
#      needs: [job-filter, ...]
#
# 2. SHARED BUILD DEPENDENCY - when multiple jobs depend on the same build,
#    the build job must include all dependent display names:
#      # build job (used by both linux-jammy-py3.10-gcc11 test AND linux-docs)
#      if: ${{ needs.job-filter.outputs.jobs == '' || contains(..., ' linux-jammy-py3.10-gcc11 ') || contains(..., ' linux-docs ') }}
#
# 3. PRE-EXISTING CONDITION - when a job has a condition that existed before filtering
#    (e.g., only run on certain events/tags), use OR logic to allow filter override:
#      if: ${{ PRE_EXISTING_CONDITION || (needs.job-filter.outputs.jobs != '' && contains(needs.job-filter.outputs.jobs, ' DISPLAY-NAME ')) }}
#    Examples of pre-existing conditions:
#      - startsWith(github.event.ref, 'refs/tags/ciflow/trunk')
#      - github.event_name == 'pull_request'
#
# 4. SECURITY CONDITIONS - conditions like `github.repository_owner == 'pytorch'`
#    must ALWAYS be enforced, keep using AND:
#      if: ${{ github.repository_owner == 'pytorch' && (needs.job-filter.outputs.jobs == '' || contains(...)) }}

on:
  workflow_call:
    inputs:
      jobs-to-include:
        required: false
        type: string
        default: ""
    outputs:
      jobs:
        description: "Space-padded job filter string"
        value: ${{ jobs.compute.outputs.jobs }}

jobs:
  compute:
    runs-on: ubuntu-latest
    outputs:
      jobs: ${{ steps.set.outputs.jobs }}
    steps:
      - name: Checkout for file-based filtering
        if: ${{ inputs.jobs-to-include == '' && github.event_name == 'pull_request' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine jobs from changed files
        id: determine
        if: ${{ inputs.jobs-to-include == '' && github.event_name == 'pull_request' }}
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          result=$(python3 .github/scripts/determine_jobs.py)
          jobs=$(echo "$result" | python3 -c "import sys,json; print(json.loads(sys.stdin.read())['jobs'])")
          echo "determined_jobs=$jobs" >> "$GITHUB_OUTPUT"

      - id: set
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          TRIGGERING_ACTOR: ${{ github.triggering_actor }}
          RUN_ID: ${{ github.run_id }}
          REPOSITORY: ${{ github.repository }}
          REF: ${{ github.ref }}
        run: |
          echo "::group::Workflow dispatch context"
          echo "event_name: $EVENT_NAME"
          echo "actor: $ACTOR"
          echo "triggering_actor: $TRIGGERING_ACTOR"
          echo "run_id: $RUN_ID"
          echo "repository: $REPOSITORY"
          echo "ref: $REF"
          echo "::endgroup::"

          # Manual override takes priority
          jobs="${{ inputs.jobs-to-include }}"
          if [ -n "$jobs" ]; then
            echo "Using manual job filter: $jobs"
            echo "jobs= ${jobs} " >> "$GITHUB_OUTPUT"
          # File-based filtering for PRs
          elif [ -n "${{ steps.determine.outputs.determined_jobs }}" ]; then
            echo "Using file-based job filter: ${{ steps.determine.outputs.determined_jobs }}"
            echo "jobs=${{ steps.determine.outputs.determined_jobs }}" >> "$GITHUB_OUTPUT"
          else
            # No filter â€” run everything (push to main, schedule, etc.)
            echo "No filter applied, running all jobs"
            echo "jobs=" >> "$GITHUB_OUTPUT"
          fi
