name: test-setup-fallback

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-setup-fallback:
    name: Test setup.py fallback commands
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PyTorch
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install pip and basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools

    - name: Test setup.py develop fallback
      run: |
        echo "Testing: python setup.py develop"
        timeout 10s python setup.py develop 2>&1 | grep "Redirecting 'python setup.py develop' to 'pip install -e . -v --no-build-isolation'" || {
          echo "Command timed out as expected after showing redirect message"
        }

    - name: Test setup.py install fallback
      run: |
        echo "Testing: python setup.py install"
        timeout 10s python setup.py install 2>&1 | grep "Redirecting 'python setup.py install' to 'pip install . -v --no-build-isolation'" || {
          echo "Command timed out as expected after showing redirect message"
        }

    - name: Verify setup.py still works for other commands
      run: |
        echo "Testing: python setup.py --help"
        python setup.py --help | head -20

    - name: Test clean command still works
      run: |
        echo "Testing: python setup.py clean"
        python setup.py clean || echo "Clean command completed"
