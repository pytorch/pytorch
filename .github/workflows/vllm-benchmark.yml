name: vLLM Benchmark

on:
  # DEBUG, TO BE REMOVED BEFORE LANDING
  pull_request:
  workflow_dispatch:
    inputs:
      pytorch_branch:
        description: |
          PyTorch branch (main, nightly, or refs/pull/PR_NUMBER/head for pull request)
        required: true
        type: string
        default: nightly
      pytorch_commit:
        description: |
          PyTorch commit (optional, default to use the latest commit from the branch)
        required: false
        type: string
      models:
        description: |
          A comma-separated list of models from pytorch-integration-testing repo (optional, default to run everything)
        required: false
        type: string
        # DEBUG: TO BE REMOVED BEFORE LANDING
        default: 'facebook/opt-125m'
      runners:
        description: |
          A comma-separated list of runners from .github/scripts/generate_vllm_benchmark_matrix.py to run the benchmark (optional, default to run everything)
        required: true
        type: string
        default: h100,b200
  schedule:
    # Run daily at 5:15 AM PST
    - cron: '15 13 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

jobs:
  set-parameters:
    runs-on: linux.2xlarge
    outputs:
      benchmark_matrix: ${{ steps.set-parameters.outputs.benchmark_matrix }}
      build-docker-image: ${{ steps.calculate-docker-image.outputs.docker-image }}
      torch-cuda-arch-list: '8.0 8.9 9.0'
      # TODO: UPGRADE TO 12.9
      build-environment: linux-jammy-cuda12.8-py3.12-gcc11
    steps:
      - uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: 3.12
          activate-environment: true

      - name: Checkout pytorch-integration-testing repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: pytorch/pytorch-integration-testing
          path: pytorch/pytorch-integration-testing
          ref: main
          fetch-depth: 0

      - name: Set parameters
        working-directory: pytorch/pytorch-integration-testing
        id: set-parameters
        shell: bash
        env:
          # DEBUG: TO BE REMOVED BEFORE LANDING
          MODELS: ${{ inputs.models || 'facebook/opt-125m' }}
          # Only need CUDA for now, we can add ROCm later if needed
          RUNNERS: ${{ inputs.runners || 'h100,b200' }}
        run: |
          set -eux

          # The generated matrix is grouped by model and runner
          python .github/scripts/generate_vllm_benchmark_matrix.py \
            --benchmark-configs-dir vllm-benchmarks/benchmarks \
            --models "${MODELS}" \
            --runners "${RUNNERS}"

      - name: Checkout PyTorch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: pytorch/pytorch
          ref: ${{ inputs.pytorch_commit || (inputs.pytorch_branch || 'nightly') }}
          show-progress: false
          fetch-depth: 0

      - name: Calculate docker image
        id: calculate-docker-image
        uses: pytorch/test-infra/.github/actions/calculate-docker-image@main
        with:
          working-directory: pytorch/pytorch
          docker-image-name: ci-image:pytorch-linux-jammy-cuda12.8-cudnn9-py3.12-gcc11-vllm

  # TODO (huydhn): Move this to a generic GHA, also this only works for CUDA in
  # the current state. I intentionally don't use _linux-build here as we'll need
  # to refactor it in the new world of open source developer cloud ARC runner.
  # And this serves as an early example using GHA container directive
  build:
    name: Build PyTorch and vLLM
    needs:
      - set-parameters
    if: ${{ !github.event.pull_request.head.repo.fork && github.repository_owner == 'pytorch' }}
    runs-on: linux.24xlarge.memory
    container:
      image: ${{ needs.set-parameters.outputs.build-docker-image }}
      options: --ipc=host --tty
      # The env inside and outside the container are different
      env:
        SKIP_SCCACHE_INITIALIZATION: 1
        SCCACHE_BUCKET: ossci-compiler-cache-circleci-v2
        SCCACHE_REGION: us-east-1
        TORCH_CUDA_ARCH_LIST: ${{ needs.set-parameters.outputs.torch-cuda-arch-list }}
        BUILD_ENVIRONMENT: ${{ needs.set-parameters.outputs.build-environment }}
    steps:
      - uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: 3.12
          activate-environment: true

      - name: Install build dependencies
        shell: bash
        run: |
          set -eux
          uv pip install pip

      - name: Checkout PyTorch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # TODO: SWITCH BACK TO NIGHTLY DEFAULT
          ref: ${{ inputs.pytorch_commit || (inputs.pytorch_branch || 'main') }}
          submodules: recursive
          show-progress: false

      - name: Get vLLM pinned commit
        id: vllm-pinned-commit
        run: |
          VLLM_PINNED_COMMIT=$(cat .github/ci_commit_pins/vllm.txt)
          echo "commit=${VLLM_PINNED_COMMIT}" >> "${GITHUB_OUTPUT}"

      - name: Checkout vLLM
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: vllm-project/vllm
          path: vllm-benchmarks/vllm
          ref: ${{ steps.vllm-pinned-commit.outputs.commit }}
          submodules: recursive
          show-progress: false

      - name: Build PyTorch
        shell: bash
        env:
          BUILD_ADDITIONAL_PACKAGES: 'vision audio'
        run: |
          set -eux
          bash .ci/pytorch/build.sh

      # Lumen CLI won't work inside the container
      - name: Build vLLM
        working-directory: vllm-project/vllm
        shell: bash
        run: |
          set -eux

          python use_existing_torch.py
          uv pip install -r requirements/build.txt

          sccache --show-stats
          python setup.py bdist_wheel --dist-dir=dist --py-limited-api=cp38
          sccache --show-stats

      - name: Copy vLLM wheel
        shell: bash
        run: |
          set -eux

          mkdir -p dist/vllm
          mv vllm-project/vllm/dist dist/vllm

  benchmarks:
    name: Run vLLM benchmarks
    needs:
      - set-parameters
      - build
    if: ${{ !github.event.pull_request.head.repo.fork && github.repository_owner == 'pytorch' }}
    strategy:
      matrix: ${{ fromJson(needs.set-parameters.outputs.benchmark_matrix) }}
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    permissions:
      id-token: write
      contents: read
    container:
      image: nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04
      options: --gpus all --ipc=host --tty
    steps:
      - name: Install system dependencies
        shell: bash
        run: |
          set -eux
          apt-get update
          apt-get install -y git

      - uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: 3.12
          activate-environment: true

      - name: Install benchmark dependencies
        shell: bash
        run: |
          set -eux
          uv pip install pip

      - name: Checkout PyTorch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: pytorch/pytorch
          ref: ${{ inputs.pytorch_commit || (inputs.pytorch_branch || 'nightly') }}
          submodules: recursive
          show-progress: false

      - name: Get workflow job id
        id: get-job-id
        uses: pytorch/test-infra/.github/actions/get-workflow-job-id@36562d6c43fa914f7bdef67ce23e5c31f1387b2e
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: DEBUG
        working-directory: pytorch/pytorch
        shell: bash
        run: |
          set -eux

          which python
          python --version

          git log

      # CHECKOUT VLLM AT THE PINNED COMMIT
      # INSTALL NIGHTLY

      - name: Gather benchmark metadata
        id: gather-benchmark-metadata
        uses: pytorch/test-infra/.github/actions/gather-benchmark-metadata@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Gather runners info
        id: gather-runners-info
        uses: pytorch/test-infra/.github/actions/gather-runners-info@main

      - name: Gather dependencies
        id: gather-dependencies
        uses: pytorch/test-infra/.github/actions/gather-dependencies@main
