name: vLLM Benchmark

on:
  # DEBUG, TO BE REMOVED BEFORE LANDING
  pull_request:
  workflow_dispatch:
    inputs:
      pytorch_branch:
        description: |
          PyTorch branch (main, nightly, or refs/pull/PR_NUMBER/head for pull request)
        required: true
        type: string
        default: nightly
      pytorch_commit:
        description: |
          PyTorch commit (optional, default to use the latest commit from the branch)
        required: false
        type: string
      models:
        description: |
          A comma-separated list of models from pytorch-integration-testing repo (optional, default to run everything)
        required: false
        type: string
        # DEBUG: TO BE REMOVED BEFORE LANDING
        default: 'facebook/opt-125m'
      runners:
        description: |
          A comma-separated list of runners from .github/scripts/generate_vllm_benchmark_matrix.py to run the benchmark (optional, default to run everything)
        required: true
        type: string
        default: h100,b200
  schedule:
    # Run daily at 5:15 AM PST
    - cron: '15 13 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

jobs:
  set-parameters:
    runs-on: ubuntu-latest
    outputs:
      benchmark_matrix: ${{ steps.set-parameters.outputs.benchmark_matrix }}
    steps:
      - name: Checkout pytorch-integration-testing repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: pytorch/pytorch-integration-testing
          path: pytorch/pytorch-integration-testing
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Set parameters
        working-directory: pytorch/pytorch-integration-testing
        id: set-parameters
        shell: bash
        env:
          # DEBUG: TO BE REMOVED BEFORE LANDING
          MODELS: ${{ inputs.models || 'facebook/opt-125m' }}
          # Only need CUDA for now, we can add ROCm later if needed
          RUNNERS: ${{ inputs.runners || 'h100,b200' }}
        run: |
          set -eux

          # The generated matrix is grouped by model and runner
          python .github/scripts/generate_vllm_benchmark_matrix.py \
            --benchmark-configs-dir vllm-benchmarks/benchmarks \
            --models "${MODELS}" \
            --runners "${RUNNERS}"

  benchmarks:
    name: Run vLLM benchmarks
    needs: set-parameters
    if: ${{ !github.event.pull_request.head.repo.fork && github.repository_owner == 'pytorch' }}
    strategy:
      matrix: ${{ fromJson(needs.set-parameters.outputs.benchmark_matrix) }}
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    permissions:
      id-token: write
      contents: read
    container:
      image: nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04
      options: --gpus all --ipc=host
    steps:
      - name: Checkout PyTorch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.pytorch_commit || (inputs.pytorch_branch || 'nightly') }}
          submodules: recursive
          show-progress: false

      - id: setup-uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: 3.12
          activate-environment: true

      - name: Get workflow job id
        id: get-job-id
        uses: pytorch/test-infra/.github/actions/get-workflow-job-id@36562d6c43fa914f7bdef67ce23e5c31f1387b2e
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Gather benchmark metadata
        id: gather-benchmark-metadata
        uses: pytorch/test-infra/.github/actions/gather-benchmark-metadata@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          venv: ${{ steps.setup-uv.outputs.venv }}

      - name: Gather runners info
        id: gather-runners-info
        uses: pytorch/test-infra/.github/actions/gather-runners-info@main
        with:
          venv: ${{ steps.setup-uv.outputs.venv }}

      - name: Gather dependencies
        id: gather-dependencies
        uses: pytorch/test-infra/.github/actions/gather-dependencies@main
        with:
          venv: ${{ steps.setup-uv.outputs.venv }}

      - name: DEBUG
        shell: bash
        run: |
          set -eux

          which python
          python --version

          git log
