


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.jit._script &mdash; PyTorch master documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/jit/_script.html"/>
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <div class="ecosystem-dropdown">
              <a id="dropdownMenuButton" data-toggle="ecosystem-dropdown">
                Ecosystem
              </a>
              <div class="ecosystem-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/hub"">
                  <span class=dropdown-title>Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class=dropdown-title>Tools & Libraries</span>
                  <p>Explore the ecosystem of tools and libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active">
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <div class="resources-dropdown">
              <a id="resourcesDropdownButton" data-toggle="resources-dropdown">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/resources"">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class=dropdown-title>About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master (1.7.0a0+03e4e94 )
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/jit/_script.html">
    You are viewing unstable developer preview docs.
    Click here to view docs for latest stable release.
  </a>
</div>

            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">Automatic Mixed Precision examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">Broadcasting semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU threading and TorchScript inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">Extending PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">Features for large-scale deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">Multiprocessing best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">Serialization semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Language Bindings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">Tensor Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.cuda.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">Complex Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">Type Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">Named Tensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">Named Tensors operator coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../__config__.html">torch.__config__</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/elastic/">TorchElastic</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch Governance | Persons of Interest</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../jit.html">torch.jit</a> &gt;</li>
        
      <li>torch.jit._script</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torch.jit._script</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;TorchScript</span>

<span class="sd">This module contains functionality to support the JIT&#39;s scripting frontend, notably:</span>
<span class="sd">    - torch.jit.script</span>

<span class="sd">This is not intended to be imported directly; please use the exposed</span>
<span class="sd">functionalities in `torch.jit`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>


<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch._jit_internal</span> <span class="k">as</span> <span class="nn">_jit_internal</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">set_module</span>
<span class="kn">from</span> <span class="nn">torch.jit._recursive</span> <span class="kn">import</span> <span class="n">ScriptMethodStub</span><span class="p">,</span> <span class="n">wrap_cpp_module</span><span class="p">,</span> <span class="n">infer_methods_to_compile</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">torch.jit._state</span> <span class="kn">import</span> <span class="n">_enabled</span>
<span class="kn">from</span> <span class="nn">torch.jit._builtins</span> <span class="kn">import</span> <span class="n">_register_builtin</span>
<span class="kn">from</span> <span class="nn">torch._six</span> <span class="kn">import</span> <span class="n">with_metaclass</span><span class="p">,</span> <span class="n">get_function_from_type</span>
<span class="kn">from</span> <span class="nn">torch.jit.frontend</span> <span class="kn">import</span> <span class="n">get_jit_def</span><span class="p">,</span> <span class="n">get_default_args</span><span class="p">,</span> <span class="n">get_jit_class_def</span>
<span class="kn">from</span> <span class="nn">torch._jit_internal</span> <span class="kn">import</span> <span class="n">_qualified_name</span>
<span class="kn">from</span> <span class="nn">torch.jit._fuser</span> <span class="kn">import</span> <span class="n">_graph_for</span>
<span class="kn">from</span> <span class="nn">torch.jit._state</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_try_get_jit_cached_function</span><span class="p">,</span>
    <span class="n">_try_get_jit_cached_overloads</span><span class="p">,</span>
    <span class="n">_set_jit_function_cache</span><span class="p">,</span>
    <span class="n">_set_jit_overload_cache</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptMethod</span><span class="o">.</span><span class="n">graph_for</span> <span class="o">=</span> <span class="n">_graph_for</span>  <span class="c1"># type: ignore</span>
<span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptFunction</span><span class="o">.</span><span class="n">graph_for</span> <span class="o">=</span> <span class="n">_graph_for</span>  <span class="c1"># type: ignore</span>
<span class="n">ScriptFunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptFunction</span>
<span class="n">ScriptFunction</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Functionally equivalent to a :class:`ScriptModule`, but represents a single</span>
<span class="s2">function and does not have any attributes or Parameters.</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">set_module</span><span class="p">(</span><span class="n">ScriptFunction</span><span class="p">,</span> <span class="s2">&quot;torch.jit&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">_enabled</span><span class="p">:</span>
    <span class="n">Attribute</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Attribute&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">Attribute</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="c1"># ScriptClasses must be new-style classes because we construct them using their</span>
<span class="c1"># __new__ method.</span>
<span class="k">def</span> <span class="nf">_is_new_style_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;__dict__&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_compile_and_register_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">rcb</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">):</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_class_def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="n">get_default_args_for_class</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_class_compile</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">rcb</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">_add_script_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">)</span>


<span class="c1"># These OrderedDictWrapper classes replace the actual OrderedDicts in</span>
<span class="c1"># module with versions that get/set properties inside of Module.</span>
<span class="c1"># This allows us to reuse most of nn.Module while still storing the</span>
<span class="c1"># data in C++.</span>
<span class="c1"># Each OrderedDict needs to support:</span>
<span class="c1">#  x not in view</span>
<span class="c1">#  x in view</span>
<span class="c1">#  view[name] = ...</span>
<span class="c1">#  view.values()</span>
<span class="c1">#  del view[name]</span>
<span class="c1">#  view.items()</span>
<span class="c1">#  view.keys()</span>
<span class="c1">#  len(view)</span>


<span class="k">class</span> <span class="nc">OrderedDictWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">_c</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot delete methods or parameters of a script module&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t add a new parameter after ScriptModule construction.&quot;</span>
                <span class="s2">&quot; Tried to add &#39;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">OrderedModuleDict</span><span class="p">(</span><span class="n">OrderedDictWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">python_dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrderedModuleDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
        <span class="c1"># contains _both_ script modules and non-script python-only modules</span>

        <span class="c1"># because script modules are subclassed in python and the</span>
        <span class="c1"># C++ Module class will not hold references to them,</span>
        <span class="c1"># to ensure that you always get the same python value here</span>
        <span class="c1"># we store it in the python dict as well</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span> <span class="o">=</span> <span class="n">python_dict</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># Cases where sub-module can be re-assigned after ScriptModule construction</span>
        <span class="c1"># 1. If the attr is an module interface type, it&#39;s guaranteed that the module is</span>
        <span class="c1">#    not inlined in the graph, so it&#39;s safe to swap a new ScriptModule in.</span>
        <span class="c1"># 2. if the new value if a ScriptModule with the same JIT type, IR won&#39;t change</span>
        <span class="c1">#    and it&#39;s legit to swap a new module in.</span>
        <span class="c1"># In these two cases we allow swapping a new scripted module and update the</span>
        <span class="c1"># corresponding python module dict to keep sync.</span>
        <span class="c1"># Note: the value to be swapped in has to be ScriptModule instead of nn.Module,</span>
        <span class="c1"># otherwise it&#39;s illegal and we throw error.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ScriptModule</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot re-assign modules in a ScriptModule with non-scripted &quot;</span>
                <span class="s2">&quot;module, tried to replace existing module &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_python_modules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<span class="c1"># For each user-defined class that subclasses ScriptModule, this meta-class:</span>
<span class="c1"># (1) finds all the methods annotated with @script_method in a ScriptModule and</span>
<span class="c1">#     removes them from the class attributes</span>
<span class="c1"># (2) puts a wrapper around the class&#39;s __init__ method to recusively compile</span>
<span class="c1">#     all of the script_methods with the module after the original __init__ has</span>
<span class="c1">#     run. This has to occur after the user-defined __init__ so that submodules and</span>
<span class="c1">#     parameters are initialized _before_ the script compiler resolve references to</span>
<span class="c1">#     `self.param` or `self.module`.</span>
<span class="k">class</span> <span class="nc">ScriptMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>  <span class="c1"># noqa: B902</span>
        <span class="c1"># Aggregate all the ScriptMethods and constants from superclasses</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__constants__&quot;</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">bases</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;_methods&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">base_constants</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;_constants_set&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_constants_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">base_constants</span><span class="p">)</span>

        <span class="c1"># find all the script methods of the current class</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ScriptMethodStub</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">original_method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_disable_script_meta&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># We leave built-in ScriptModule types alone, since this metaclass</span>
            <span class="c1"># is only for compiling user classes that inherit from</span>
            <span class="c1"># ScriptModule.</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="n">original_init</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">original_init</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">init_then_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">)</span>
            <span class="n">original_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">added_methods_in_init</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_methods</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">make_stubs</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_methods&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_methods</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">infer_methods_to_compile</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span>
                    <span class="s2">&quot;_actual_script_module&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">create_script_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">make_stubs</span><span class="p">,</span> <span class="n">share_types</span><span class="o">=</span><span class="ow">not</span> <span class="n">added_methods_in_init</span><span class="p">)</span>

                <span class="c1"># Delete the Python attributes that now shadow the ScriptModule</span>
                <span class="c1"># ones, so that __getattr__ and __setattr__ will properly find</span>
                <span class="c1"># the scripted versions.</span>
                <span class="n">concrete_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">_concrete_type</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">concrete_type</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">():</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">concrete_type</span><span class="o">.</span><span class="n">get_modules</span><span class="p">():</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_parameters&quot;</span><span class="p">,</span> <span class="s2">&quot;_buffers&quot;</span><span class="p">,</span> <span class="s2">&quot;_modules&quot;</span><span class="p">):</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">init_then_script</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CachedForward</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="s2">&quot;forward&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<span class="k">class</span> <span class="nc">ScriptWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">script_method</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c1"># NOTE: we need to traverse two frames here because the meta-class frame</span>
    <span class="c1"># for ScriptModule will be present, as opposed to invoking @script on a</span>
    <span class="c1"># a function or invoking define() on a CompilationUnit.</span>
    <span class="c1"># The stack will look like:</span>
    <span class="c1">#</span>
    <span class="c1"># 0. createResolutionCallback()</span>
    <span class="c1"># 1. script_method()</span>
    <span class="c1"># 2. ScriptModule metaclass frame</span>
    <span class="c1"># 3. Surrounding scope</span>
    <span class="c1">#</span>
    <span class="c1"># createResolutionCallback internally adds 1 to get us to the scope of this</span>
    <span class="c1"># function (the calling function). Adding 2 gets us to the proper surrounding scope.</span>
    <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">self_name</span><span class="o">=</span><span class="s2">&quot;ScriptModule&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ScriptMethodStub</span><span class="p">(</span><span class="n">_rcb</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ConstMap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">const_mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_mapping</span> <span class="o">=</span> <span class="n">const_mapping</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_mapping</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>


<span class="k">if</span> <span class="n">_enabled</span><span class="p">:</span>
    <span class="c1"># this is a Python &#39;non-data descriptor&#39; that causes the first access</span>
    <span class="c1"># to ScriptModule&#39;s forward to lookup the forward method and stash</span>
    <span class="c1"># it in the objects dict. Due to the standard rules for attribute lookup</span>
    <span class="c1"># subsequent lookups will just directly return the previously looked up method.</span>
    <span class="c1"># This is necessary because nn.Module defines forward as a method. If we</span>
    <span class="c1"># did nothing __getattr__ would not be called. Instead we&#39;d get nn.Module.forward</span>
    <span class="c1"># which always throws an exception.</span>

    <span class="k">class</span> <span class="nc">ScriptModule</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">ScriptMeta</span><span class="p">,</span> <span class="n">Module</span><span class="p">)):</span>  <span class="c1"># type: ignore</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``ScriptModule``s wrap a C++ ``torch::jit::Module``. ``ScriptModule``s</span>
<span class="sd">        contain methods, attributes, parameters, and</span>
<span class="sd">        constants. These can be accessed the same as on a normal ``nn.Module``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__jit_unused_properties__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;code_with_constants&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;inlined_graph&#39;</span><span class="p">,</span> <span class="s1">&#39;original_name&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">forward</span> <span class="o">=</span> <span class="n">_CachedForward</span><span class="p">()</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="c1"># Unwrap torch.jit.Attribute into a regular setattr + recording</span>
                <span class="c1"># the provided type in __annotations__.</span>
                <span class="c1">#</span>
                <span class="c1"># This ensures that if we use the attr again in `__init__`, it</span>
                <span class="c1"># will look like the actual value, not an instance of Attribute.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
                    <span class="c1"># NB: Ensure that we set __annotations__ on the specific</span>
                    <span class="c1"># class in question, and not on a superclass (which would</span>
                    <span class="c1"># be wrong wrong wrong!).</span>
                    <span class="c1"># See also https://github.com/pytorch/pytorch/issues/39463</span>
                    <span class="k">if</span> <span class="s2">&quot;__annotations__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">type</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_actual_script_module&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="c1"># If we have completed initialization, just defer to the</span>
                <span class="c1"># backing RecursiveScriptModule to eagerly compile the provided</span>
                <span class="c1"># source.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

            <span class="c1"># Otherwise, we are still in the object&#39;s __init__.</span>
            <span class="c1"># In that case, add `src` as a stub to be compiled.</span>
            <span class="c1">#</span>
            <span class="c1"># We use frames_up=1 to get to the proper surrounding scope. The stack</span>
            <span class="c1"># will look like:</span>
            <span class="c1"># 0. createResolutionCallback</span>
            <span class="c1"># 1. define()</span>
            <span class="c1"># 2. surrounding scope.</span>
            <span class="c1">#</span>
            <span class="c1"># createResolutionCallback internally adds 1 to get us to our frame, then</span>
            <span class="c1"># we add 1 to get to the proper surrounding scope.</span>
            <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_parse_source_def</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ScriptMethodStub</span><span class="p">(</span><span class="n">rcb</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_script_module</span><span class="o">.</span><span class="n">_replicate_for_data_parallel</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">RecursiveScriptModule</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">):</span>
        <span class="c1"># XXX: RecursiveScriptModule inherits from ScriptModule for the sole</span>
        <span class="c1"># reason that it retains the existing isinstance(ScriptModule)</span>
        <span class="c1"># behavior.</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The core data structure in TorchScript is the ``ScriptModule``. It is an</span>
<span class="sd">        analogue of torch&#39;s ``nn.Module`` and represents an entire model as a tree of</span>
<span class="sd">        submodules. Like normal modules, each individual module in a ``ScriptModule`` can</span>
<span class="sd">        have submodules, parameters, and methods. In ``nn.Module``\s methods are implemented</span>
<span class="sd">        as Python functions, but in ``ScriptModule``\s methods are implemented as</span>
<span class="sd">        TorchScript functions,  a statically-typed subset of Python that contains all</span>
<span class="sd">        of PyTorch&#39;s built-in Tensor operations. This difference allows your</span>
<span class="sd">        ``ScriptModule``\s code to run without the need for a Python interpreter.</span>

<span class="sd">        ``ScriptModule``\s should not be created manually, instead use</span>
<span class="sd">        either :func:`tracing &lt;torch.jit.trace&gt;` or :func:`scripting &lt;torch.jit.script&gt;`.</span>
<span class="sd">        Tracing and scripting can be applied incrementally and :ref:`composed as necessary &lt;Types&gt;`.</span>

<span class="sd">        * Tracing records the tensor operations as executed with a set of example inputs and uses these</span>
<span class="sd">          operations to construct a computation graph. You can use the full dynamic behavior of Python with tracing,</span>
<span class="sd">          but values other than Tensors and control flow aren&#39;t captured in the graph.</span>

<span class="sd">        * Scripting inspects the Python code of the model</span>
<span class="sd">          and compiles it to TorchScript. Scripting allows the use of many `types`_ of values and supports dynamic control flow.</span>
<span class="sd">          Many, but not all features of Python are supported by the compiler, so changes to the source code may be necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_disable_script_meta</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpp_module</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">cpp_module</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="c1"># Delete the &#39;training&#39; attribute set up by `Module.__init__`. It</span>
            <span class="c1"># will get set on the underlying cpp module, so we delete it here</span>
            <span class="c1"># to avoid this version shadowing the cpp module version.</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;training&quot;</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_construct</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct a RecursiveScriptModule that&#39;s ready for use. PyTorch</span>
<span class="sd">            code should use this to construct a RecursiveScriptModule instead</span>
<span class="sd">            of instead of calling `__init__` directly, as it makes sure the</span>
<span class="sd">            object is properly finalized (and in the future we may take</span>
<span class="sd">            control of how the RecursiveScriptModule instance is created).</span>

<span class="sd">            Arguments:</span>
<span class="sd">                cpp_module:  The C++ Module that will hold the actual state of</span>
<span class="sd">                             this RecursiveScriptModule instance.</span>
<span class="sd">                init_fn:  Lambda that initializes the RecursiveScriptModule passed to it.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">script_module</span> <span class="o">=</span> <span class="n">RecursiveScriptModule</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>
            <span class="n">init_fn</span><span class="p">(</span><span class="n">script_module</span><span class="p">)</span>

            <span class="c1"># Finalize the ScriptModule: replace the nn.Module state with our</span>
            <span class="c1"># custom implementations and flip the _initializing bit.</span>
            <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="n">_finalize_scriptmodule</span><span class="p">(</span><span class="n">script_module</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">script_module</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_finalize_scriptmodule</span><span class="p">(</span><span class="n">script_module</span><span class="p">):</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">(</span><span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_buffers</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">OrderedModuleDict</span><span class="p">(</span>
                <span class="n">script_module</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">script_module</span><span class="o">.</span><span class="n">_modules</span>
            <span class="p">)</span>
            <span class="n">script_module</span><span class="o">.</span><span class="n">_initializing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">_reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpp_module</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Re-construct an instance of RecursiveScriptModule using an instance of a C++ module.</span>

<span class="sd">            Arguments:</span>
<span class="sd">                cpp_module: The C++ module that this RecursiveScriptModule will be rebuilt around.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="c1"># Copy the concrete type from the C++ module to this ScriptModule.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ConcreteModuleType</span><span class="o">.</span><span class="n">from_jit_type</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="c1"># Copy submodules from the C++ module to this ScriptModule.</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cpp_module</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">cpp_module</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">OrderedModuleDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>

            <span class="c1"># Copy parameters and buffers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffers</span> <span class="o">=</span> <span class="n">OrderedDictWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>

            <span class="c1"># Get rid of the functions from the old C++ module.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">ScriptMethod</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_initializing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a string representation of the internal graph for the</span>
<span class="sd">            ``forward`` method. See :ref:`interpreting-graphs` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">graph</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">inlined_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a string representation of the internal graph for the</span>
<span class="sd">            ``forward`` method. This graph will be preprocessed to inline all function and method calls.</span>
<span class="sd">            See :ref:`interpreting-graphs` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">inlined_graph</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a pretty-printed representation (as valid Python syntax) of</span>
<span class="sd">            the internal graph for the ``forward`` method. See</span>
<span class="sd">            :ref:`inspecting-code` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">code</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">code_with_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a tuple of:</span>

<span class="sd">            [0] a pretty-printed representation (as valid Python syntax) of</span>
<span class="sd">            the internal graph for the ``forward`` method. See `code`.</span>
<span class="sd">            [1] a ConstMap following the CONSTANT.cN format of the output in [0].</span>
<span class="sd">            The indices in the [0] output are keys to the underlying constant&#39;s values.</span>

<span class="sd">            See :ref:`inspecting-code` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">code_with_constants</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ConstMap</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            save(f, _extra_files={})</span>

<span class="sd">            See :func:`torch.jit.save &lt;torch.jit.save&gt;` for details.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_save_for_lite_interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            _save_for_lite_interpreter(f)</span>

<span class="sd">            Add (or update) the bytecode session to the script model. The updated model is used</span>
<span class="sd">            in lite interpreter for mobile applications.</span>

<span class="sd">            Arguments:</span>
<span class="sd">                f: a string containing a file name.</span>
<span class="sd">                _extra_files: Map from filename to contents which will be stored as part of &#39;f&#39;.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_save_for_mobile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_save_to_buffer_for_lite_interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_save_to_buffer_for_mobile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">save_to_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">save_to_buffer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_debug_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">get_debug_state</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;original_name=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">graph_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="o">.</span><span class="n">graph_for</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">original_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()):</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_type</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
            <span class="c1"># We use frames_up=1 to get to the proper surrounding scope. The stack</span>
            <span class="c1"># will look like:</span>
            <span class="c1"># 0. createResolutionCallback</span>
            <span class="c1"># 1. define()</span>
            <span class="c1"># 2. surrounding scope.</span>
            <span class="c1">#</span>
            <span class="c1"># createResolutionCallback internally adds 1 to get us to our frame, then</span>
            <span class="c1"># we add 1 to get to the proper surrounding scope.</span>
            <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">frames_up</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_define</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">rcb</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_initializing&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;ScriptModule has not been initialized, did you forget to call super&#39;s init?&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initializing</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="c1"># _modules check is before hasattr since modules are included as attributes in _c,</span>
            <span class="c1"># but we want to get the python wrapper from _modules instead of the raw _c object.</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_has_method</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="n">script_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_get_method</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="c1"># cache method so future calls do not go through __getattr__</span>
                <span class="c1"># to improve invocation performance</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_method</span>
                <span class="k">return</span> <span class="n">script_method</span>

            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initializing</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_concrete_type&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concrete_type</span><span class="o">.</span><span class="n">get_constants</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="c1"># TODO: we don&#39;t have _concrete_type set after load(), and in general we lose constant information.</span>
                <span class="c1"># We should encode constants as class type attributes (or something) so it persists across save/load.</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot mutate TorchScript constant value: &#39;</span><span class="si">{}</span><span class="s2">&#39;. Value: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">attr</span><span class="p">,</span> <span class="n">value</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We allow setting Python attributes on the ScriptModule, for</span>
                <span class="c1"># when people want to stash some convenience info on it.</span>
                <span class="c1"># TODO: it&#39;s possible that the following is confusing:</span>
                <span class="c1">#   s = torch.jit.script(...)</span>
                <span class="c1">#   s.python_attr = ...</span>
                <span class="c1">#   s.save()   &lt;--- this doesn&#39;t have `python_attr`</span>
                <span class="c1"># It&#39;s fairly trivial to save enough info to warn in this case.</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">(</span>
                <span class="s2">&quot;ScriptModules cannot be deepcopied using copy.deepcopy or saved using torch.save. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Mixed serialization of script and non-script modules is not supported. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;For purely script modules use my_script_module.save(&lt;filename&gt;) instead.&quot;</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">wrap_cpp_module</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>

        <span class="c1"># Python magic methods do method lookups on an object&#39;s class type, instead of looking up</span>
        <span class="c1"># the method defines on the class instance. In order to continue to expose the magic methods</span>
        <span class="c1"># of builtin-containers (ModuleList, Sequential, ModuleDict) to python we</span>
        <span class="c1"># define magic methods here as a shim to the correct attribute.</span>
        <span class="k">def</span> <span class="nf">forward_magic_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">self_method</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="n">method_name</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__getitem__&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__len__&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_magic_method</span><span class="p">(</span><span class="s2">&quot;__contains__&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># dir is defined by the base nn.Module, so instead of throwing if</span>
        <span class="c1"># it is not overriden, we call into the nn.Module __dir__ method</span>
        <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__dir__</span>
            <span class="k">if</span> <span class="n">self_method</span><span class="o">.</span><span class="vm">__func__</span> <span class="o">==</span> <span class="n">get_function_from_type</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="s2">&quot;__dir__&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">()</span>

        <span class="c1"># to resolve bool(value), python looks if __bool__ is defined then __iter__</span>
        <span class="c1"># is defined then returns true for classes. because __iter__() on this</span>
        <span class="c1"># class throws if it isn&#39;t overriden, we define __bool__ to preserve default behavior</span>
        <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">self_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__bool__</span>
            <span class="k">if</span> <span class="n">self_method</span><span class="o">.</span><span class="vm">__func__</span> <span class="o">==</span> <span class="n">get_function_from_type</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="s2">&quot;__bool__&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">self_method</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># we have to initialize ScriptModule properly so that</span>
            <span class="c1"># it works with pybind11</span>
            <span class="k">def</span> <span class="nf">init_fn</span><span class="p">(</span><span class="n">script_module</span><span class="p">):</span>
                <span class="c1"># Don&#39;t do anything here, we&#39;ll initialize the ScriptModule below</span>
                <span class="k">return</span>

            <span class="k">return</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="n">_construct</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">_replicate_for_data_parallel</span><span class="p">(),</span> <span class="n">init_fn</span>
            <span class="p">)</span>

    <span class="c1"># Need to copy all RecursiveScriptModule methods to ScriptModule.</span>
    <span class="c1">#</span>
    <span class="c1"># This is because `super(MyScriptModule, self).foo()` does not use</span>
    <span class="c1"># `__getattr__` to look up `foo`. So we need to make each method available on</span>
    <span class="c1"># the ScriptModule manually.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># We can copy over the implementation wholesale because besides the</span>
        <span class="c1"># `super()` thing above, ScriptModule behaves exactly like</span>
        <span class="c1"># RecursiveScriptModule</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_methods</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="c1"># In Python 3 unbound methods are functions, but in Python 2 they are methods</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">_compiled_methods_allowlist</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
        <span class="s2">&quot;register_buffer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;register_parameter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;add_module&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_apply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;to&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;float&quot;</span><span class="p">,</span>
        <span class="s2">&quot;double&quot;</span><span class="p">,</span>
        <span class="s2">&quot;half&quot;</span><span class="p">,</span>
        <span class="s2">&quot;state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_save_to_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_load_from_state_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_named_members&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;buffers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_buffers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;children&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_children&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;named_modules&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zero_grad&quot;</span><span class="p">,</span>
        <span class="s2">&quot;share_memory&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_get_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extra_repr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_slow_forward&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_tracing_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
        <span class="s2">&quot;train&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_make_fail</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; is not supported on ScriptModules&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fail</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">_get_methods</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RecursiveScriptModule</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_compiled_methods_allowlist</span>
        <span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">RecursiveScriptModule</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">_make_fail</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">else</span><span class="p">:</span>
    <span class="c1"># TODO MAKE SURE THAT DISABLING WORKS</span>
    <span class="k">class</span> <span class="nc">ScriptModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">RecursiveScriptModule</span><span class="p">(</span><span class="n">ScriptModule</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>


<div class="viewcode-block" id="script"><a class="viewcode-back" href="../../../generated/torch.jit.script.html#torch.jit.script">[docs]</a><span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_frames_up</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_rcb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scripting a function or ``nn.Module`` will inspect the source code, compile</span>
<span class="sd">    it as TorchScript code using the TorchScript compiler, and return a :class:`ScriptModule` or</span>
<span class="sd">    :class:`ScriptFunction`. TorchScript itself is a subset of the Python language, so not all</span>
<span class="sd">    features in Python work, but we provide enough functionality to compute on</span>
<span class="sd">    tensors and do control-dependent operations. For a complete guide, see the</span>
<span class="sd">    :ref:`language-reference`.</span>

<span class="sd">    ``torch.jit.script`` can be used as a function for modules and functions, and as a decorator</span>
<span class="sd">    ``@torch.jit.script`` for :ref:`torchscript-classes` and functions.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        obj (callable, class, or ``nn.Module``):  The ``nn.Module``, function, or class type to</span>
<span class="sd">                                                  compile.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If ``obj`` is ``nn.Module``, ``script`` returns</span>
<span class="sd">        a :class:`ScriptModule` object. The returned :class:`ScriptModule` will</span>
<span class="sd">        have the same set of sub-modules and parameters as the</span>
<span class="sd">        original ``nn.Module``. If ``obj`` is a standalone function,</span>
<span class="sd">        a :class:`ScriptFunction` will be returned.</span>

<span class="sd">    **Scripting a function**</span>
<span class="sd">        The ``@torch.jit.script`` decorator will construct a :class:`ScriptFunction`</span>
<span class="sd">        by compiling the body of the function.</span>

<span class="sd">        Example (scripting a function):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>

<span class="sd">            @torch.jit.script</span>
<span class="sd">            def foo(x, y):</span>
<span class="sd">                if x.max() &gt; y.max():</span>
<span class="sd">                    r = x</span>
<span class="sd">                else:</span>
<span class="sd">                    r = y</span>
<span class="sd">                return r</span>

<span class="sd">            print(type(foo))  # torch.jit.ScriptFuncion</span>

<span class="sd">            # See the compiled graph as Python code</span>
<span class="sd">            print(foo.code)</span>

<span class="sd">            # Call the function using the TorchScript interpreter</span>
<span class="sd">            foo(torch.ones(2, 2), torch.ones(2, 2))</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">            :hide:</span>

<span class="sd">            ...</span>

<span class="sd">    **Scripting an nn.Module**</span>
<span class="sd">        Scripting an ``nn.Module`` by default will compile the ``forward`` method and recursively</span>
<span class="sd">        compile any methods, submodules, and functions called by ``forward``. If a ``nn.Module`` only uses</span>
<span class="sd">        features supported in TorchScript, no changes to the original module code should be necessary. ``script``</span>
<span class="sd">        will construct :class:`ScriptModule` that has copies of the attributes, parameters, and methods of</span>
<span class="sd">        the original module.</span>

<span class="sd">        Example (scripting a simple module with a Parameter):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>

<span class="sd">            class MyModule(torch.nn.Module):</span>
<span class="sd">                def __init__(self, N, M):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>
<span class="sd">                    # This parameter will be copied to the new ScriptModule</span>
<span class="sd">                    self.weight = torch.nn.Parameter(torch.rand(N, M))</span>

<span class="sd">                    # When this submodule is used, it will be compiled</span>
<span class="sd">                    self.linear = torch.nn.Linear(N, M)</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    output = self.weight.mv(input)</span>

<span class="sd">                    # This calls the `forward` method of the `nn.Linear` module, which will</span>
<span class="sd">                    # cause the `self.linear` submodule to be compiled to a `ScriptModule` here</span>
<span class="sd">                    output = self.linear(output)</span>
<span class="sd">                    return output</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule(2, 3))</span>

<span class="sd">        Example (scripting a module with traced submodules):</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>
<span class="sd">            import torch.nn.functional as F</span>

<span class="sd">            class MyModule(nn.Module):</span>
<span class="sd">                def __init__(self):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>
<span class="sd">                    # torch.jit.trace produces a ScriptModule&#39;s conv1 and conv2</span>
<span class="sd">                    self.conv1 = torch.jit.trace(nn.Conv2d(1, 20, 5), torch.rand(1, 1, 16, 16))</span>
<span class="sd">                    self.conv2 = torch.jit.trace(nn.Conv2d(20, 20, 5), torch.rand(1, 20, 16, 16))</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    input = F.relu(self.conv1(input))</span>
<span class="sd">                    input = F.relu(self.conv2(input))</span>
<span class="sd">                    return input</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule())</span>

<span class="sd">        To compile a method other than ``forward`` (and recursively compile anything it calls), add</span>
<span class="sd">        the :func:`@torch.jit.export &lt;torch.jit.export&gt;` decorator to the method. To opt out of compilation</span>
<span class="sd">        use :func:`@torch.jit.ignore &lt;torch.jit.ignore&gt;` or :func:`@torch.jit.unused &lt;torch.jit.unused&gt;`.</span>

<span class="sd">        Example (an exported and ignored method in a module)::</span>

<span class="sd">            import torch</span>
<span class="sd">            import torch.nn as nn</span>

<span class="sd">            class MyModule(nn.Module):</span>
<span class="sd">                def __init__(self):</span>
<span class="sd">                    super(MyModule, self).__init__()</span>

<span class="sd">                @torch.jit.export</span>
<span class="sd">                def some_entry_point(self, input):</span>
<span class="sd">                    return input + 10</span>

<span class="sd">                @torch.jit.ignore</span>
<span class="sd">                def python_only_fn(self, input):</span>
<span class="sd">                    # This function won&#39;t be compiled, so any</span>
<span class="sd">                    # Python APIs can be used</span>
<span class="sd">                    import pdb</span>
<span class="sd">                    pdb.set_trace()</span>

<span class="sd">                def forward(self, input):</span>
<span class="sd">                    if self.training:</span>
<span class="sd">                        self.python_only_fn(input)</span>
<span class="sd">                    return input * 99</span>

<span class="sd">            scripted_module = torch.jit.script(MyModule())</span>
<span class="sd">            print(scripted_module.some_entry_point(torch.randn(2, 2)))</span>
<span class="sd">            print(scripted_module(torch.randn(2, 2)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="n">optimize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;`optimize` is deprecated and has no effect. Use `with torch.jit.optimized_execution() instead&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ScriptModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">create_script_module</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">_recursive</span><span class="o">.</span><span class="n">infer_methods_to_compile</span>
        <span class="p">)</span>

    <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="c1"># If this type is a `nn.Module` subclass, they probably meant to pass</span>
        <span class="c1"># an instance instead of a Module</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Type &#39;</span><span class="si">{}</span><span class="s2">&#39; cannot be compiled since it inherits&quot;</span>
                <span class="s2">&quot; from nn.Module,&quot;</span>
                <span class="s2">&quot; pass an instance instead&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_new_style_class</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;TorchScript classes must be new-style classes. &quot;</span>
                <span class="s2">&quot;Please inherit from &#39;object&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;TorchScript classes does not support inheritance yet. &quot;</span>
                <span class="s2">&quot;Please directly inherit from &#39;object&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_rcb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">_frames_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_compile_and_register_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_rcb</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is a decorated fn, and we need to the underlying fn and its rcb</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__script_if_tracing_wrapper&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__original_fn</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">_check_directly_compile_overloaded</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">maybe_already_compiled_fn</span> <span class="o">=</span> <span class="n">_try_get_jit_cached_function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maybe_already_compiled_fn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maybe_already_compiled_fn</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_rcb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_compile</span><span class="p">(</span>
            <span class="n">qualified_name</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">_rcb</span><span class="p">,</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Forward docstrings</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">_set_jit_function_cache</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span></div>


<span class="c1"># overloads are registered in _jit_internal and compiled here so that _overload</span>
<span class="c1"># can be used in nn/functional.py without an import cycle</span>


<span class="k">def</span> <span class="nf">_check_overload_defaults</span><span class="p">(</span><span class="n">impl_defaults</span><span class="p">,</span> <span class="n">overload_defaults</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">overload_value</span> <span class="ow">in</span> <span class="n">overload_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">impl_defaults</span> <span class="ow">or</span> <span class="n">impl_defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">overload_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="n">FrontendError</span><span class="p">(</span>
                <span class="n">loc</span><span class="p">,</span>
                <span class="s2">&quot;Default parameters on overloads do not affect the runtime so they &quot;</span>
                <span class="s2">&quot;must equal to the default parameter on the implementation function. Found on &quot;</span>
                <span class="s2">&quot;parameter </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="k">def</span> <span class="nf">_compile_function_with_overload</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">qual_name</span><span class="p">,</span> <span class="n">impl_fn</span><span class="p">):</span>
    <span class="n">overload_decl</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">overload_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span>
    <span class="n">overload_signature</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get_signature</span><span class="p">(</span>
        <span class="n">overload_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">impl_ast</span> <span class="o">=</span> <span class="n">get_jit_def</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">,</span> <span class="n">impl_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">overload_defaults</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">)</span>
    <span class="n">implementation_defaults</span> <span class="o">=</span> <span class="n">get_default_args</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">)</span>
    <span class="n">_rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromClosure</span><span class="p">(</span><span class="n">impl_fn</span><span class="p">)</span>
    <span class="n">_check_overload_defaults</span><span class="p">(</span>
        <span class="n">implementation_defaults</span><span class="p">,</span> <span class="n">overload_defaults</span><span class="p">,</span> <span class="n">overload_decl</span><span class="o">.</span><span class="n">range</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_compile_overload</span><span class="p">(</span>
        <span class="n">qual_name</span><span class="p">,</span>
        <span class="n">overload_decl</span><span class="p">,</span>
        <span class="n">impl_ast</span><span class="p">,</span>
        <span class="n">_rcb</span><span class="p">,</span>
        <span class="n">implementation_defaults</span><span class="p">,</span>
        <span class="n">overload_signature</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">_get_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="c1"># check for cached compiled fns</span>
    <span class="n">existing_compiled_fns</span> <span class="o">=</span> <span class="n">_try_get_jit_cached_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">uncompiled_overloads</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_get_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uncompiled_overloads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">existing_compiled_fns</span>

    <span class="n">compiled_fns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">overload_fn</span> <span class="ow">in</span> <span class="n">uncompiled_overloads</span><span class="p">:</span>
        <span class="n">compiled_fns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">_compile_function_with_overload</span><span class="p">(</span><span class="n">overload_fn</span><span class="p">,</span> <span class="n">qual_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">existing_compiled_fns</span><span class="p">:</span>
        <span class="n">compiled_fns</span> <span class="o">=</span> <span class="n">existing_compiled_fns</span> <span class="o">+</span> <span class="n">compiled_fns</span>

    <span class="c1"># cache compilation, remove information stored to do compilation</span>
    <span class="n">_set_jit_overload_cache</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compiled_fns</span><span class="p">)</span>
    <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_clear_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiled_fns</span>


<span class="k">def</span> <span class="nf">_check_directly_compile_overloaded</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">_get_fn_overloads</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_try_get_jit_cached_overloads</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Function </span><span class="si">{}</span><span class="s2"> cannot be directly compiled because it&quot;</span>
            <span class="s2">&quot; is overloaded. It must be used in a context of a function&quot;</span>
            <span class="s2">&quot; where its inputs can determine which overload to call.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qual_name</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">interface</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;interface must be applied to a class&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_new_style_class</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;TorchScript interfaces must inherit from &#39;object&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Expected MRO is:</span>
    <span class="c1">#   User module</span>
    <span class="c1">#   torch.nn.modules.module.Module</span>
    <span class="c1">#   object</span>
    <span class="n">is_module_interface</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_module_interface</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;TorchScript interface does not support inheritance yet. &quot;</span>
            <span class="s2">&quot;Please directly inherit from &#39;object&#39; or &#39;nn.Module&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if this type is a `nn.Module` subclass, generate an module interface type</span>
    <span class="c1"># instead of a class interface type, an module interface type only compile</span>
    <span class="c1"># the user provided methods as part of the interface</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">get_jit_class_def</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_jit_script_interface_compile</span><span class="p">(</span>
        <span class="n">qualified_name</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">rcb</span><span class="p">,</span> <span class="n">is_module_interface</span>
    <span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__torch_script_interface__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_recursive_compile_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
    <span class="n">_qual_name</span> <span class="o">=</span> <span class="n">_qualified_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="c1"># We&#39;re starting a new compilation, so update the error call stack in</span>
    <span class="c1"># case it fails</span>
    <span class="n">error_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">CallStack</span><span class="p">(</span><span class="n">_qual_name</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackForClassMethods</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">_compile_and_register_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">rcb</span><span class="p">,</span> <span class="n">_qual_name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompilationUnit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_frames_up</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">CompilationUnit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">_frames_up</span><span class="o">=</span><span class="n">_frames_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">define</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">rcb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_frames_up</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rcb</span><span class="p">:</span>
            <span class="n">rcb</span> <span class="o">=</span> <span class="n">_jit_internal</span><span class="o">.</span><span class="n">createResolutionCallbackFromFrame</span><span class="p">(</span><span class="n">_frames_up</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">rcb</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">find_function</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;CompilationUnit&#39; has no attribute &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">_unwrap_optional</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Unwrapping null optional&quot;</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="n">_register_builtin</span><span class="p">(</span><span class="n">_unwrap_optional</span><span class="p">,</span> <span class="s2">&quot;aten::_unwrap_optional&quot;</span><span class="p">)</span>
<span class="n">_register_builtin</span><span class="p">(</span><span class="n">_jit_internal</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">,</span> <span class="s2">&quot;aten::is_scripting&quot;</span><span class="p">)</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Torch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/language_data.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90545585-1', 'auto');
  ga('send', 'pageview');

</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>

<script>
  window.dataLayer = window.dataLayer || [];

  function gtag(){dataLayer.push(arguments);}

  gtag('js', new Date());
  gtag('config', 'UA-117752657-2');
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/features">Features</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active">
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>